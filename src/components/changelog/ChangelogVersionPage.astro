---
import {
  getLangFromUrl,
  useTranslatedPath,
  useTranslations,
} from "../../i18n/utils";
import Layout from "../../layouts/Layout.astro";
import { getChangelogEntryByVersion } from "../../lib/changelog";
import { githubReleaseTagUrl } from "../../lib/github";
import Footer from "../Footer.astro";
import Header from "../Header.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { translatePath } = useTranslatedPath(lang);

const { version } = Astro.params;
if (!version) {
  throw new Error("Missing version param");
}

const isJa = lang === "ja";

const jaEntry = isJa
  ? await getChangelogEntryByVersion("ja", version)
  : undefined;
const enEntry = await getChangelogEntryByVersion("en", version);

const entry = (isJa ? (jaEntry ?? enEntry) : enEntry) ?? undefined;
if (!entry) {
  throw new Error(`Changelog entry not found for version: ${version}`);
}

const untranslated = Boolean(isJa && !jaEntry);

const { Content } = await entry.render();

const dateFormatter = new Intl.DateTimeFormat(isJa ? "ja-JP" : "en-US", {
  year: "numeric",
  month: isJa ? "long" : "short",
  day: isJa ? "numeric" : "2-digit",
});
---

<Layout
  title={`HardwareVisualizer - ${entry.data.title}`}
  lang={isJa ? "ja" : "en"}
  description={entry.data.summary ?? t("changelog.description")}
>
  <Header />

  <main class="pt-24 md:pt-28 pb-16">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl">
        <a
          href={translatePath("/changelog")}
          class="text-sm text-slate-600 dark:text-slate-300 hover:text-cyan-500 dark:hover:text-cyan-400 transition-colors"
          data-astro-prefetch
        >
          ← {t("changelog.back")}
        </a>

        <h1
          class="mt-4 text-3xl md:text-4xl font-bold text-slate-900 dark:text-white"
        >
          {entry.data.title}
        </h1>

        <div
          class="mt-3 flex flex-wrap items-center gap-2 text-sm text-slate-500 dark:text-slate-400"
        >
          <span class="font-mono">v{entry.data.version}</span>
          <span aria-hidden="true">•</span>
          <time datetime={entry.data.date.toISOString()}>
            {dateFormatter.format(entry.data.date)}
          </time>
          <span aria-hidden="true">•</span>
          <a
            href={githubReleaseTagUrl(entry.data.version)}
            target="_blank"
            rel="noopener noreferrer"
            class="text-cyan-600 dark:text-cyan-400 hover:underline"
          >
            {t("changelog.githubRelease")}
          </a>
        </div>

        {
          untranslated ? (
            <div class="mt-6 rounded-xl border border-amber-200/80 bg-amber-50/80 px-4 py-3 text-amber-800 dark:border-amber-400/30 dark:bg-amber-400/10 dark:text-amber-200">
              <p class="text-sm">{t("changelog.untranslatedNotice")}</p>
            </div>
          ) : null
        }

        {
          entry.data.tags?.length ? (
            <div class="mt-4 flex flex-wrap gap-2">
              {entry.data.tags.map((tag) => (
                <span class="inline-flex items-center rounded-full border border-slate-200 px-2.5 py-1 text-slate-600 text-xs dark:border-slate-700 dark:text-slate-300">
                  {tag}
                </span>
              ))}
            </div>
          ) : null
        }

        <article class="prose prose-slate dark:prose-invert max-w-none mt-8">
          <Content />
        </article>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
