---
import { Image } from "astro:assets";
import slide01 from "../assets/screenshots/slide-1.png";
import slideLight01 from "../assets/screenshots/slide-1-l.png";
import slide02 from "../assets/screenshots/slide-2.png";
import slideLight02 from "../assets/screenshots/slide-2-l.png";
import slide03 from "../assets/screenshots/slide-3.png";
import slideLight03 from "../assets/screenshots/slide-3-l.png";
import slide04 from "../assets/screenshots/slide-4.png";
import slideLight04 from "../assets/screenshots/slide-4-l.png";
import slide05 from "../assets/screenshots/slide-5.png";
import slideLight05 from "../assets/screenshots/slide-5-l.png";
import slide06 from "../assets/screenshots/slide-6.png";
import slideLight06 from "../assets/screenshots/slide-6-l.png";

const slides = [
  {
    key: "slide-1",
    alt: "Screenshot of Dashboard",
    light: slideLight01,
    dark: slide01,
  },
  {
    key: "slide-2",
    alt: "Screenshot of Insights",
    light: slideLight02,
    dark: slide02,
  },
  {
    key: "slide-3",
    alt: "Screenshot of CPU Usage",
    light: slideLight03,
    dark: slide03,
  },
  {
    key: "slide-4",
    alt: "Screenshot of Process Insight",
    light: slideLight04,
    dark: slide04,
  },
  {
    key: "slide-5",
    alt: "Screenshot of Settings",
    light: slideLight05,
    dark: slide05,
  },
  {
    key: "slide-6",
    alt: "Screenshot of GPU Insights",
    light: slideLight06,
    dark: slide06,
  },
] as const;
---

<div class="py-16 bg-neutral-200 dark:bg-slate-900">
  <div class="swiper swiper-container">
    <div class="swiper-wrapper">
      {
        slides.map((slide) => (
          <div class="swiper-slide">
            <div class="screenshot-slot" data-screenshot={slide.key}>
              <noscript>
                <Image src={slide.light} alt={slide.alt} />
              </noscript>
            </div>
          </div>
        ))
      }
    </div>

    <div class="swiper-pagination"></div>

    <div class="swiper-button swiper-button-prev" aria-label="Previous"></div>
    <div class="swiper-button swiper-button-next" aria-label="Next"></div>

    <div class="swiper-scrollbar"></div>
  </div>

  {
    slides.map((slide, index) => (
      <>
        <template data-screenshot-template={slide.key} data-theme="light">
          <Image
            src={slide.light}
            alt={slide.alt}
            data-screenshot={slide.key}
            loading={index < 2 ? "eager" : "lazy"}
          />
        </template>
        <template data-screenshot-template={slide.key} data-theme="dark">
          <Image
            src={slide.dark}
            alt={slide.alt}
            data-screenshot={slide.key}
            loading={index < 2 ? "eager" : "lazy"}
          />
        </template>
      </>
    ))
  }
</div>
<style is:global>
  .swiper-wrapper {
    max-width: 800px;
    max-height: 500px;
  }

  .swiper-slide img {
    height: auto;
    max-width: 100%;
    object-fit: cover;
  }

  /* ページネーションの通常色 */
  .swiper-pagination-bullet {
    background: oklch(0.9107 0.0214 222.77) !important;
  }

  /* ページネーションのアクティブ色 */
  .swiper-pagination-bullet-active {
    background: oklch(0.9107 0.0214 222.77) !important;
    opacity: 1 !important;
  }

  .swiper-button::after {
    font-size: 32px;
    color: oklch(0.9107 0.0214 222.77);
  }
</style>

<script>
  import type { SwiperOptions } from "swiper/types";

  type Theme = "light" | "dark";

  const getCurrentTheme = (): Theme => {
    return document.documentElement.classList.contains("dark")
      ? "dark"
      : "light";
  };

  const applyScreenshotsForTheme = (theme: Theme) => {
    const templates = document.querySelectorAll<HTMLTemplateElement>(
      `template[data-screenshot-template][data-theme="${theme}"]`,
    );

    const templateByKey = new Map<string, HTMLTemplateElement>();
    for (const template of templates) {
      const key = template.getAttribute("data-screenshot-template");
      if (key) templateByKey.set(key, template);
    }

    const slots = document.querySelectorAll<HTMLElement>(
      ".swiper .screenshot-slot[data-screenshot]",
    );
    for (const slot of slots) {
      const key = slot.getAttribute("data-screenshot");
      if (!key) continue;

      const template = templateByKey.get(key);
      if (!template) continue;

      slot.replaceChildren(template.content.cloneNode(true));
    }
  };

  const swiperConfig: SwiperOptions = {
    loop: true,

    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    },

    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev",
    },

    scrollbar: {
      el: ".swiper-scrollbar",
    },

    autoplay: {
      delay: 3000,
      disableOnInteraction: true,
    },

    spaceBetween: 24,
    speed: 600,

    slidesPerView: 1,
    slidesPerGroup: 1,

    breakpoints: {
      1024: {
        slidesPerView: 2,
        slidesPerGroup: 2,
      },
      1920: {
        slidesPerView: 3,
        slidesPerGroup: 3,
      },
    },
  };

  // Swiper の動的インポートと初期化
  const initSwiper = async () => {
    const initialTheme = getCurrentTheme();
    applyScreenshotsForTheme(initialTheme);

    // Swiper と CSS を動的にインポート
    const [{ default: Swiper }, { Navigation, Pagination, Autoplay }] =
      await Promise.all([import("swiper"), import("swiper/modules")]);

    // CSS も動的にインポート
    await Promise.all([
      import("swiper/css"),
      import("swiper/css/navigation"),
      import("swiper/css/pagination"),
      import("swiper/css/scrollbar"),
    ]);

    // Swiper を初期化
    const swiper = new Swiper(".swiper", {
      ...swiperConfig,
      modules: [Navigation, Pagination, Autoplay],
    });

    // テーマ変更の監視
    let lastTheme: Theme = initialTheme;
    const themeObserver = new MutationObserver(() => {
      const nextTheme = getCurrentTheme();
      if (nextTheme === lastTheme) return;

      applyScreenshotsForTheme(nextTheme);
      swiper.update();
      lastTheme = nextTheme;
    });

    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    window.addEventListener("beforeunload", () => {
      themeObserver.disconnect();
    });
  };

  // Intersection Observer でビューポートに近づいた時に Swiper を読み込み
  const swiperContainer = document.querySelector(".swiper-container");
  if (swiperContainer) {
    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting) {
          initSwiper();
          observer.disconnect();
        }
      },
      {
        rootMargin: "200px", // 200px手前から読み込み開始
      },
    );

    observer.observe(swiperContainer);
  }
</script>
